
-- =================================================================
-- JOURNEY APP: NET WORTH & ASSET INHERITANCE SYSTEM
-- =================================================================

BEGIN;

-- 1. UPDATE BUY LOGIC: PRESERVE ASSET VALUE
-- We drop the old function that "drained" the XP.
-- The new function transfers ownership but KEEPS the attached_xp on the item.
DROP FUNCTION IF EXISTS buy_avatar(uuid, uuid);

CREATE OR REPLACE FUNCTION buy_avatar(p_listing_id uuid, p_buyer_id uuid)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_seller_id uuid;
    v_avatar_id uuid;
    v_price bigint;
    v_attached_xp bigint;
    v_buyer_balance bigint;
    v_fee bigint;
    v_seller_share bigint;
BEGIN
    -- Get listing details
    SELECT seller_id, avatar_id, price, attached_xp 
    INTO v_seller_id, v_avatar_id, v_price, v_attached_xp
    FROM public.marketplace_listings
    WHERE id = p_listing_id AND status = 'active'
    FOR UPDATE;

    IF NOT FOUND THEN RAISE EXCEPTION 'Listing not found or active'; END IF;
    IF v_seller_id = p_buyer_id THEN RAISE EXCEPTION 'Cannot buy your own avatar'; END IF;

    -- Check buyer LIQUID balance
    SELECT total_points INTO v_buyer_balance FROM public.users WHERE id = p_buyer_id;
    IF v_buyer_balance < v_price THEN RAISE EXCEPTION 'Insufficient Liquid XP'; END IF;

    -- Calculate Splits
    v_fee := floor(v_price * 0.30);
    v_seller_share := v_price - v_fee;

    -- 1. Transfer Liquid Funds
    UPDATE public.users SET total_points = total_points - v_price WHERE id = p_buyer_id;
    UPDATE public.users SET total_points = total_points + v_seller_share WHERE id = v_seller_id;
    UPDATE public.treasury SET balance = balance + v_fee, total_volume = total_volume + v_price WHERE id = 1;

    -- 2. Transfer Asset (Inheritance)
    -- We DO NOT reset attached_xp. The buyer inherits the artifact AND its value.
    UPDATE public.avatar_history SET user_id = p_buyer_id WHERE id = v_avatar_id;
    
    -- 3. Close Listing
    UPDATE public.marketplace_listings SET status = 'sold' WHERE id = p_listing_id;

    -- 4. Log Achievement
    INSERT INTO public.activity_feed (user_id, activity_type, details)
    VALUES (p_buyer_id, 'achievement', jsonb_build_object('title', 'Wealth Inherited', 'icon', 'ðŸ’Ž', 'asset_value', v_attached_xp));

    RETURN true;
END;
$$;

-- 2. GET PLAYER WEALTH RPC
-- Calculates Liquid XP, Asset XP (Sum of owned artifacts), and Net Worth.
CREATE OR REPLACE FUNCTION get_player_wealth(p_user_id uuid)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_liquid_xp bigint;
    v_asset_xp bigint;
BEGIN
    -- Get Liquid
    SELECT total_points INTO v_liquid_xp FROM public.users WHERE id = p_user_id;
    
    -- Get Assets Sum (Inventory)
    SELECT COALESCE(SUM(attached_xp), 0) INTO v_asset_xp 
    FROM public.avatar_history 
    WHERE user_id = p_user_id;

    RETURN jsonb_build_object(
        'liquid_xp', COALESCE(v_liquid_xp, 0),
        'asset_xp', v_asset_xp,
        'net_worth', (COALESCE(v_liquid_xp, 0) + v_asset_xp)
    );
END;
$$;

COMMIT;
