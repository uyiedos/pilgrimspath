
-- =================================================================
-- JOURNEY APP: TREASURY LOGIC V2 (Enhanced Ledger)
-- =================================================================

BEGIN;

-- 1. Update spend_points to accept transaction type
CREATE OR REPLACE FUNCTION spend_points(p_user_id uuid, p_amount int, p_type text DEFAULT 'system_fee')
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  current_points bigint;
BEGIN
  SELECT total_points INTO current_points FROM public.users WHERE id = p_user_id;
  
  IF current_points < p_amount THEN RETURN false; END IF;

  -- Deduct
  UPDATE public.users SET total_points = total_points - p_amount WHERE id = p_user_id;
  
  -- Add to Treasury Balance
  UPDATE public.treasury SET balance = balance + p_amount WHERE id = 1;

  -- Log Ledger
  INSERT INTO public.transactions (sender_id, amount, type)
  VALUES (p_user_id, p_amount, p_type);

  RETURN true;
END;
$$;

-- 2. Update create_giveaway to log creation fee
CREATE OR REPLACE FUNCTION create_giveaway(p_title text, p_desc text, p_image text, p_fee int, p_winners int, p_end timestamp with time zone, p_poster_id uuid)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_xp bigint;
    v_new_id uuid;
    v_create_fee int := 500;
BEGIN
    SELECT total_points INTO v_user_xp FROM public.users WHERE id = p_poster_id;
    
    IF v_user_xp < 5000 THEN
        RAISE EXCEPTION 'Minimum 5000 XP required to host a giveaway.';
    END IF;

    -- Deduct Creation Fee
    UPDATE public.users SET total_points = total_points - v_create_fee WHERE id = p_poster_id;
    UPDATE public.treasury SET balance = balance + v_create_fee WHERE id = 1;

    -- Log Ledger
    INSERT INTO public.transactions (sender_id, amount, type, metadata)
    VALUES (p_poster_id, v_create_fee, 'giveaway_fee', jsonb_build_object('title', p_title));

    INSERT INTO public.giveaways (poster_id, title, description, image, entry_fee, winners_count, end_time, status)
    VALUES (p_poster_id, p_title, p_desc, p_image, p_fee, p_winners, p_end, 'active')
    RETURNING id INTO v_new_id;

    RETURN v_new_id;
END;
$$;

-- 3. Update enter_giveaway to log fee split
CREATE OR REPLACE FUNCTION enter_giveaway(p_giveaway_id uuid, p_user_id uuid)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_fee int;
    v_poster_id uuid;
    v_user_xp bigint;
    v_user_activity int;
    v_weight float8;
    v_treasury_share int;
    v_poster_share int;
    v_title text;
BEGIN
    SELECT entry_fee, poster_id, title INTO v_fee, v_poster_id, v_title FROM public.giveaways WHERE id = p_giveaway_id AND status = 'active';
    IF NOT FOUND THEN RAISE EXCEPTION 'Giveaway not found or inactive'; END IF;

    SELECT total_points, daily_points_earned INTO v_user_xp, v_user_activity FROM public.users WHERE id = p_user_id;
    IF v_user_xp < v_fee THEN RAISE EXCEPTION 'Insufficient XP'; END IF;

    -- Deduct Fee
    UPDATE public.users SET total_points = total_points - v_fee WHERE id = p_user_id;

    -- Calculate Split (30% Treasury, 70% Poster)
    v_treasury_share := floor(v_fee * 0.3);
    v_poster_share := v_fee - v_treasury_share;

    UPDATE public.treasury SET balance = balance + v_treasury_share WHERE id = 1;
    UPDATE public.users SET total_points = total_points + v_poster_share WHERE id = v_poster_id;

    -- Log Transactions
    INSERT INTO public.transactions (sender_id, amount, type, metadata)
    VALUES (p_user_id, v_treasury_share, 'giveaway_tax', jsonb_build_object('giveaway', v_title));
    
    INSERT INTO public.transactions (sender_id, receiver_id, amount, type, metadata)
    VALUES (p_user_id, v_poster_id, v_poster_share, 'giveaway_entry', jsonb_build_object('giveaway', v_title));

    -- Join Logic
    v_weight := (v_user_xp::float8 / 1000.0) + (v_user_activity::float8 / 10.0) + 1.0;
    INSERT INTO public.giveaway_participants (giveaway_id, user_id, xp_at_entry, activity_at_entry, weight)
    VALUES (p_giveaway_id, p_user_id, v_user_xp, v_user_activity, v_weight);

    UPDATE public.giveaways SET participants_count = participants_count + 1 WHERE id = p_giveaway_id;

    RETURN true;
END;
$$;

-- 4. Update enter_official_raffle to log entry
CREATE OR REPLACE FUNCTION enter_official_raffle(p_raffle_id uuid, p_user_id uuid)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_fee int;
    v_user_xp bigint;
    v_user_activity int;
    v_weight float8;
    v_email text;
    v_title text;
BEGIN
    SELECT entry_fee, title INTO v_fee, v_title FROM public.raffles WHERE id = p_raffle_id AND status = 'active';
    IF NOT FOUND THEN RAISE EXCEPTION 'Raffle not found or inactive'; END IF;

    SELECT total_points, daily_points_earned, email INTO v_user_xp, v_user_activity, v_email 
    FROM public.users WHERE id = p_user_id;
    IF v_user_xp < v_fee THEN RAISE EXCEPTION 'Insufficient XP'; END IF;

    UPDATE public.users SET total_points = total_points - v_fee WHERE id = p_user_id;
    UPDATE public.treasury SET balance = balance + v_fee WHERE id = 1;

    -- Log Ledger
    INSERT INTO public.transactions (sender_id, amount, type, metadata)
    VALUES (p_user_id, v_fee, 'raffle_entry', jsonb_build_object('raffle', v_title));

    v_weight := (v_user_xp::float8 / 2000.0) + (v_user_activity::float8 / 20.0) + 1.0;

    INSERT INTO public.raffle_participants (raffle_id, user_id, user_email, weight)
    VALUES (p_raffle_id, p_user_id, v_email, v_weight);

    UPDATE public.raffles SET participants_count = participants_count + 1 WHERE id = p_raffle_id;

    RETURN true;
END;
$$;

COMMIT;
