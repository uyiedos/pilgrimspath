
-- =================================================================
-- GIVEAWAY IMAGES & STORAGE SETUP
-- =================================================================

BEGIN;

-- 1. Ensure Storage Bucket Exists (Idempotent)
INSERT INTO storage.buckets (id, name, public) 
VALUES ('journey_assets', 'journey_assets', true) 
ON CONFLICT (id) DO NOTHING;

-- 2. Ensure Storage Policy for Uploads
-- Drop existing first to avoid conflict if not checking for existence
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING ( bucket_id = 'journey_assets' );

DROP POLICY IF EXISTS "Auth Uploads" ON storage.objects;
CREATE POLICY "Auth Uploads" ON storage.objects FOR INSERT TO authenticated WITH CHECK ( bucket_id = 'journey_assets' );

-- 3. Ensure 'image' and 'social_link' columns exist on giveaways
ALTER TABLE public.giveaways ADD COLUMN IF NOT EXISTS image text;
ALTER TABLE public.giveaways ADD COLUMN IF NOT EXISTS social_link text;

COMMIT;
